<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¡ˆä»¶ç®¡ç†ç³»ç»Ÿ - ç‹¬ç«‹ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background-color: #1a73e8;
            color: white;
            padding: 15px 0;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 500;
        }
        
        .header .date {
            font-size: 14px;
            margin-top: 5px;
            opacity: 0.9;
        }
        
        .steps {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
            position: relative;
        }
        
        .steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 15%;
            right: 15%;
            height: 2px;
            background-color: #e0e0e0;
            z-index: 1;
        }
        
        .step {
            text-align: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }
        
        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e0e0e0;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .step.active .step-icon {
            background-color: #1a73e8;
            color: white;
        }
        
        .step-label {
            font-size: 14px;
            color: #666;
        }
        
        .step.active .step-label {
            color: #1a73e8;
            font-weight: 500;
        }
        
        .form-container {
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            max-width: 600px;
            margin: 0 auto;
        }
        
        h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        input[type="text"], input[type="tel"], select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        input[type="text"]:focus, input[type="tel"]:focus, select:focus {
            outline: none;
            border-color: #1a73e8;
        }
        
        .btn {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
        }
        
        .btn:hover {
            background-color: #1557b0;
        }
        
        .result-message {
            text-align: center;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .result-success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        
        .result-rejected {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        
        .result-pending {
            background-color: #fff8e1;
            color: #f57c00;
            border: 1px solid #ffe0b2;
        }
        
        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .time-slot {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .time-slot:hover {
            border-color: #1a73e8;
            background-color: #f5f7fa;
        }
        
        .time-slot.selected {
            background-color: #1a73e8;
            color: white;
            border-color: #1a73e8;
        }
        
        .time-slot.booked {
            background-color: #f5f5f5;
            color: #999;
            cursor: not-allowed;
            border-color: #ddd;
        }
        
        .help-tips {
            background-color: #f8f9fa;
            border-left: 4px solid #1a73e8;
            padding: 15px;
            margin-top: 30px;
            border-radius: 0 4px 4px 0;
        }
        
        .help-tips h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #1a73e8;
        }
        
        .help-tips ul {
            list-style-type: none;
            padding-left: 0;
        }
        
        .help-tips li {
            font-size: 14px;
            margin-bottom: 8px;
            padding-left: 15px;
            position: relative;
        }
        
        .help-tips li::before {
            content: 'â€¢';
            color: #1a73e8;
            position: absolute;
            left: 0;
        }
        
        .footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px 0;
            color: #666;
            font-size: 14px;
            border-top: 1px solid #e0e0e0;
        }
        
        .hidden {
            display: none;
        }
        
        .success-icon {
            font-size: 48px;
            color: #4caf50;
            margin-bottom: 20px;
        }
        
        .booking-details {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        
        .booking-details p {
            margin: 8px 0;
        }
        
        @media (max-width: 768px) {
            .steps {
                flex-wrap: wrap;
            }
            
            .steps::before {
                display: none;
            }
            
            .form-container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
            <div class="container">
                <h1>éå…¬è¯ç»§æ‰¿é¢„çº¦ç³»ç»Ÿ</h1>
                <div class="date" id="current-date"></div>
            </div>
        </div>
    
    <div class="container">
        <div class="steps">
            <div class="step active" id="step-1">
                <div class="step-icon">ğŸ”</div>
                <div class="step-label">æŸ¥è¯¢è¿›åº¦</div>
            </div>
            <div class="step" id="step-2">
                <div class="step-icon">ğŸ“‹</div>
                <div class="step-label">å®¡æ ¸ç»“æœ</div>
            </div>
            <div class="step" id="step-3">
                <div class="step-icon">ğŸ“…</div>
                <div class="step-label">é€‰æ‹©æ—¶é—´</div>
            </div>
            <div class="step" id="step-4">
                <div class="step-icon">âœ…</div>
                <div class="step-label">å®Œæˆé¢„çº¦</div>
            </div>
        </div>
        
        <div class="form-container">
            <!-- æ­¥éª¤1: æŸ¥è¯¢è¡¨å• -->
            <div id="form-step-1">
                <h2>æŸ¥è¯¢æ¡ˆä»¶è¿›åº¦</h2>
                <div class="form-group">
                    <label for="name">è¯·è¾“å…¥äº§æƒäººçš„å§“å</label>
                    <input type="text" id="name" placeholder="è¯·è¾“å…¥äº§æƒäººçš„å§“å">
                </div>
                <div class="form-group">
                    <label for="phone">è¯·è¾“å…¥æ‰‹æœºå·ç </label>
                    <input type="tel" id="phone" placeholder="è¯·è¾“å…¥æ‚¨çš„æ‰‹æœºå·ç ">
                </div>
                <button class="btn" id="query-btn">æŸ¥è¯¢</button>
            </div>
            
            <!-- æ­¥éª¤2: å®¡æ ¸ç»“æœ -->
            <div id="form-step-2" class="hidden">
                <h2>å®¡æ ¸ç»“æœ</h2>
                <div id="result-message" class="result-message"></div>
                <div id="result-actions" class="hidden">
                    <button class="btn" id="book-btn">é¢„çº¦ç°åœºåŠç†</button>
                </div>
                <button class="btn hidden" id="view-appointment-btn" style="margin-top: 10px;">æŸ¥çœ‹å·²é¢„çº¦ä¿¡æ¯</button>
                <button class="btn" id="back-to-query" style="margin-top: 10px;">è¿”å›æŸ¥è¯¢</button>
            </div>
            
            <!-- æ­¥éª¤3: é€‰æ‹©æ—¶é—´ -->
            <div id="form-step-3" class="hidden">
                <h2>é€‰æ‹©é¢„çº¦æ—¶é—´</h2>
                <div class="form-group">
                    <label for="booking-year">é€‰æ‹©å¹´ä»½</label>
                    <select id="booking-year">
                        <option value="2025">2025å¹´</option>
                        <option value="2026">2026å¹´</option>
                        <option value="2027">2027å¹´</option>
                        <option value="2028">2028å¹´</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="booking-month">é€‰æ‹©æœˆä»½</label>
                    <select id="booking-month">
                        <option value="1">1æœˆ</option>
                        <option value="2">2æœˆ</option>
                        <option value="3">3æœˆ</option>
                        <option value="4">4æœˆ</option>
                        <option value="5">5æœˆ</option>
                        <option value="6">6æœˆ</option>
                        <option value="7">7æœˆ</option>
                        <option value="8">8æœˆ</option>
                        <option value="9">9æœˆ</option>
                        <option value="10">10æœˆ</option>
                        <option value="11">11æœˆ</option>
                        <option value="12">12æœˆ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="booking-date">é€‰æ‹©æ—¥æœŸ</label>
                    <select id="booking-date"></select>
                </div>
                <div class="form-group">
                    <label>é€‰æ‹©æ—¶é—´æ®µ</label>
                    <div class="time-slots" id="time-slots"></div>
                </div>
                <button class="btn" id="confirm-time-btn">ç¡®è®¤é¢„çº¦</button>
                <button class="btn" id="back-to-result" style="margin-top: 10px; background-color: #666;">è¿”å›ç»“æœ</button>
            </div>
            
            <!-- æ­¥éª¤4: å®Œæˆé¢„çº¦ -->
            <div id="form-step-4" class="hidden">
                <h2 style="text-align: center;">é¢„çº¦æˆåŠŸï¼</h2>
                <div class="success-icon" style="text-align: center;">âœ“</div>
                <div class="booking-details">
                    <p><strong>å§“åï¼š</strong><span id="booking-name"></span></p>
                    <p><strong>æ‰‹æœºå·ç ï¼š</strong><span id="booking-phone"></span></p>
                    <p><strong>é¢„çº¦æ—¥æœŸï¼š</strong><span id="booking-date-display"></span></p>
                    <p><strong>é¢„çº¦æ—¶é—´ï¼š</strong><span id="booking-time-display"></span></p>
                </div>
                <p style="text-align: center; color: #666;">æˆ‘ä»¬å·²å‘æ‚¨çš„æ‰‹æœºå‘é€äº†é¢„çº¦æˆåŠŸçŸ­ä¿¡ï¼Œè¯·å‡†æ—¶å‰å¾€åŠç†ã€‚</p>
                <button class="btn hidden" id="cancel-appointment-btn" style="margin-bottom: 10px;">å–æ¶ˆé¢„çº¦</button>
                <button class="btn hidden" id="change-appointment-btn" style="margin-bottom: 10px;">æ›´æ”¹é¢„çº¦æ—¶é—´</button>
                <button class="btn hidden" id="new-appointment-btn" style="margin-bottom: 10px;">é‡æ–°é¢„çº¦</button>
                <button class="btn" id="new-query-btn">æ–°çš„æŸ¥è¯¢</button>
            </div>
        </div>
        
        <div class="help-tips">
            <h3>æ¸©é¦¨æç¤º</h3>
            <ul>
                <li>å®¡æ ¸é€šè¿‡åï¼Œå¯ä»¥éšæ—¶è¿›è¡Œé¢„çº¦æ“ä½œ</li>
                <li>åŠç†å½•éŸ³å½•åƒçš„æ—¶é—´æš‚æ—¶ä»…ä¸ºæ¯å‘¨çš„æ˜ŸæœŸå››ã€æ˜ŸæœŸäº”</li>
                <li>é¢„çº¦æˆåŠŸåï¼Œç³»ç»Ÿå°†å‘é€çŸ­ä¿¡æé†’è‡³æ‚¨é¢„ç•™çš„è”ç³»ç”µè¯</li>
                <li>å¦‚æœ‰ç–‘é—®ï¼Œè¯·åœ¨å‘¨ä¸€è‡³å‘¨äº”çš„ä¸Šç­æ—¶é—´è”ç³»å·¥ä½œäººå‘˜ï¼š0668-2798581ï¼ˆä¸Šåˆ8:30-12:00ï¼Œä¸‹åˆ14:30-17:30ï¼‰</li>
            </ul>
        </div>
    </div>
    
    <div class="footer">
            <div class="container">
                Â© 2023 éå…¬è¯ç»§æ‰¿é¢„çº¦ç³»ç»Ÿ - ä¿ç•™æ‰€æœ‰æƒåˆ©
            </div>
        </div>
    
    <script src="data-sync.js"></script>
    <script>
        // å½“å‰æ—¥æœŸæ˜¾ç¤º
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®å½“å‰æ—¥æœŸ
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('zh-CN', options);
            
            // ä½¿ç”¨DataSyncæ¨¡å—
            // å½“å‰ç”¨æˆ·ä¿¡æ¯
            let currentUser = null;
            let selectedSlot = null;
            
            // åˆå§‹åŒ–DataSyncæ¨¡å—
            if (typeof DataSync !== 'undefined') {
                DataSync.init();
            } else {
                console.error('DataSyncæ¨¡å—æœªåŠ è½½æˆåŠŸ');
            }
            
            // æ­¥éª¤å¯¼èˆª
            function goToStep(stepNumber) {
                // éšè—æ‰€æœ‰æ­¥éª¤
                for (let i = 1; i <= 4; i++) {
                    document.getElementById(`form-step-${i}`).classList.add('hidden');
                    document.getElementById(`step-${i}`).classList.remove('active');
                }
                
                // æ˜¾ç¤ºå½“å‰æ­¥éª¤
                document.getElementById(`form-step-${stepNumber}`).classList.remove('hidden');
                document.getElementById(`step-${stepNumber}`).classList.add('active');
                
                // æ›´æ–°è¿›åº¦æ¡
                for (let i = 1; i <= stepNumber; i++) {
                    document.getElementById(`step-${i}`).classList.add('active');
                }
            }
            
            // ç”Ÿæˆå¯ç”¨æ—¶æ®µ
            function generateTimeSlots(date) {
                const slotsContainer = document.getElementById('time-slots');
                slotsContainer.innerHTML = '';
                
                const slots = ['09:00-10:00', '10:00-11:00', '15:00-16:00', '16:00-17:00'];
                // è·å–å·²é¢„çº¦æ—¶æ®µ - ä½¿ç”¨AppointmentManager
                const booked = DataSync.AppointmentManager.getBookedSlotsByDate(date);
                
                slots.forEach(slot => {
                    const slotElement = document.createElement('div');
                    slotElement.className = 'time-slot';
                    slotElement.textContent = slot;
                    
                    if (booked.includes(slot)) {
                        slotElement.classList.add('booked');
                    } else {
                        slotElement.addEventListener('click', function() {
                            // ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
                            document.querySelectorAll('.time-slot.selected').forEach(el => {
                                el.classList.remove('selected');
                            });
                            // æ·»åŠ å½“å‰é€‰ä¸­çŠ¶æ€
                            slotElement.classList.add('selected');
                            selectedSlot = slot;
                        });
                    }
                    
                    slotsContainer.appendChild(slotElement);
                });
            }
            
            // æŸ¥è¯¢æŒ‰é’®äº‹ä»¶
            document.getElementById('query-btn').addEventListener('click', function() {
                const name = document.getElementById('name').value.trim();
                const phone = document.getElementById('phone').value.trim();
                
                if (!name || !phone) {
                    alert('è¯·è¾“å…¥å§“åå’Œæ‰‹æœºå·ç ');
                    return;
                }
                
                // æŸ¥è¯¢æ•°æ®åº“ - ä½¿ç”¨CaseManager
                const user = DataSync.CaseManager.getCaseByNameAndPhone(name, phone);
                
                if (user) {
                    currentUser = user;
                    // è®¾ç½®ç»“æœæ•°æ®
                    const resultMessage = document.getElementById('result-message');
                    const resultActions = document.getElementById('result-actions');
                    
                    // æ¸…ç©ºä¹‹å‰çš„çŠ¶æ€
                    resultMessage.className = 'result-message';
                    resultActions.classList.add('hidden');
                    
                    // æŸ¥æ‰¾ç”¨æˆ·çš„é¢„çº¦è®°å½• - ä½¿ç”¨AppointmentManager
                    const userAppointment = DataSync.AppointmentManager.getAppointmentByUser(name, phone);
                    
                    // è®¾ç½®ç»“æœæ¶ˆæ¯å’Œæ ·å¼
                    if (user.status === 'approved') {
                        if (userAppointment) {
                            resultMessage.innerHTML = `<strong>æ­å–œï¼Œæ‚¨çš„ç”³è¯·å·²å®¡æ ¸é€šè¿‡ï¼</strong><br/>æ‚¨å·²é¢„çº¦${userAppointment.displayDate} ${userAppointment.time}çš„åŠç†æ—¶æ®µ`;
                            resultMessage.classList.add('result-success');
                            // éšè—é¢„çº¦æŒ‰é’®ï¼Œæ˜¾ç¤ºæŸ¥çœ‹é¢„çº¦æŒ‰é’®
                            document.getElementById('book-btn').classList.add('hidden');
                            document.getElementById('view-appointment-btn').classList.remove('hidden');
                        } else {
                            resultMessage.innerHTML = '<strong>æ­å–œï¼Œæ‚¨çš„ç”³è¯·å·²å®¡æ ¸é€šè¿‡ï¼</strong><br/>æ‚¨å¯ä»¥ç«‹å³è¿›è¡Œç°åœºåŠç†é¢„çº¦';
                            resultMessage.classList.add('result-success');
                            resultActions.classList.remove('hidden');
                        }
                    } else if (user.status === 'rejected') {
                        resultMessage.innerHTML = `<strong>å¾ˆæŠ±æ­‰ï¼Œæ‚¨çš„ç”³è¯·æœªé€šè¿‡å®¡æ ¸</strong><br/>${user.reason}`;
                        resultMessage.classList.add('result-rejected');
                    } else if (user.status === 'pending') {
                        resultMessage.innerHTML = `<strong>æ‚¨çš„ç”³è¯·æ­£åœ¨å¤„ç†ä¸­</strong><br/>${user.reason || 'è¯·è€å¿ƒç­‰å¾…å®¡æ ¸ç»“æœ'}`;
                        resultMessage.classList.add('result-pending');
                    }
                    
                    // ç¡®ä¿ç»“æœåŒºåŸŸæœ‰è¶³å¤Ÿçš„é«˜åº¦æ˜¾ç¤ºå®Œæ•´å†…å®¹
                    resultMessage.style.minHeight = '80px';
                    resultMessage.style.display = 'flex';
                    resultMessage.style.flexDirection = 'column';
                    resultMessage.style.justifyContent = 'center';
                    
                    // å¯¼èˆªåˆ°æ­¥éª¤2
                    goToStep(2);
                } else {
                    alert('æœªæ‰¾åˆ°ç›¸å…³è®°å½•ï¼Œè¯·æ£€æŸ¥å§“åå’Œæ‰‹æœºå·ç æ˜¯å¦æ­£ç¡®');
                }
            });
            
            // æ ¹æ®å¹´æœˆè·å–æ‰€æœ‰å‘¨å››å’Œå‘¨äº”çš„æ—¥æœŸ
            function getWeekdaysInMonth(year, month) {
                const weekdays = [];
                const daysInMonth = new Date(year, month, 0).getDate();
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month - 1, day);
                    const dayOfWeek = date.getDay();
                    
                    // å‘¨å››(4)æˆ–å‘¨äº”(5)
                    if (dayOfWeek === 4 || dayOfWeek === 5) {
                        const formattedDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const dayName = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][dayOfWeek];
                        weekdays.push({
                            date: formattedDate,
                            display: `${month}æœˆ${day}æ—¥ (å‘¨${dayName})`
                        });
                    }
                }
                
                return weekdays;
            }
            
            // å¡«å……æ—¥æœŸä¸‹æ‹‰æ¡†
            function populateDateDropdown(year, month) {
                const dateSelect = document.getElementById('booking-date');
                dateSelect.innerHTML = '';
                
                const weekdays = getWeekdaysInMonth(year, month);
                
                if (weekdays.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'è¯¥æœˆä»½æ²¡æœ‰å¯ç”¨çš„å‘¨å››æˆ–å‘¨äº”';
                    option.disabled = true;
                    dateSelect.appendChild(option);
                } else {
                    weekdays.forEach(day => {
                        const option = document.createElement('option');
                        option.value = day.date;
                        option.textContent = day.display;
                        dateSelect.appendChild(option);
                    });
                    
                    // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªæ—¥æœŸ
                    if (dateSelect.options.length > 0) {
                        dateSelect.selectedIndex = 0;
                        generateTimeSlots(dateSelect.value);
                    }
                }
            }
            
            // é¢„çº¦æŒ‰é’®äº‹ä»¶
            document.getElementById('book-btn').addEventListener('click', function() {
                // é‡ç½®æŒ‰é’®çŠ¶æ€
                document.getElementById('book-btn').classList.remove('hidden');
                document.getElementById('view-appointment-btn').classList.add('hidden');
                // åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨
                const year = parseInt(document.getElementById('booking-year').value);
                const month = parseInt(document.getElementById('booking-month').value);
                populateDateDropdown(year, month);
                goToStep(3);
            });
            
            // å¹´ä»½é€‰æ‹©å˜æ›´äº‹ä»¶
            document.getElementById('booking-year').addEventListener('change', function() {
                const year = parseInt(this.value);
                const month = parseInt(document.getElementById('booking-month').value);
                populateDateDropdown(year, month);
                selectedSlot = null;
            });
            
            // æœˆä»½é€‰æ‹©å˜æ›´äº‹ä»¶
            document.getElementById('booking-month').addEventListener('change', function() {
                const year = parseInt(document.getElementById('booking-year').value);
                const month = parseInt(this.value);
                populateDateDropdown(year, month);
                selectedSlot = null;
            });
            
            // æ—¥æœŸé€‰æ‹©å˜æ›´äº‹ä»¶
            document.getElementById('booking-date').addEventListener('change', function() {
                if (this.value) {
                    generateTimeSlots(this.value);
                }
                selectedSlot = null;
            });
            
            // æŸ¥çœ‹é¢„çº¦æŒ‰é’®äº‹ä»¶
            document.getElementById('view-appointment-btn').addEventListener('click', function() {
                const userAppointment = DataSync.AppointmentManager.getAppointmentByUser(currentUser.name, currentUser.phone);
                if (userAppointment) {
                    // å¡«å……é¢„çº¦ä¿¡æ¯
                    document.getElementById('booking-name').textContent = userAppointment.name;
                    document.getElementById('booking-phone').textContent = userAppointment.phone;
                    document.getElementById('booking-date-display').textContent = userAppointment.displayDate;
                    document.getElementById('booking-time-display').textContent = userAppointment.time;
                    
                    // æ˜¾ç¤ºå–æ¶ˆå’Œæ›´æ”¹æŒ‰é’®
                    document.getElementById('cancel-appointment-btn').classList.remove('hidden');
                    document.getElementById('change-appointment-btn').classList.remove('hidden');
                    document.getElementById('new-appointment-btn').classList.add('hidden');
                    
                    goToStep(4);
                }
            });
            
            // å–æ¶ˆé¢„çº¦æŒ‰é’®äº‹ä»¶
            document.getElementById('cancel-appointment-btn').addEventListener('click', function() {
                if (confirm('ç¡®å®šè¦å–æ¶ˆé¢„çº¦å—ï¼Ÿ')) {
                    // ä½¿ç”¨AppointmentManagerå–æ¶ˆé¢„çº¦
                    DataSync.AppointmentManager.cancelAppointment(currentUser.name, currentUser.phone);
                    
                    alert('é¢„çº¦å·²å–æ¶ˆ');
                    // è¿”å›æŸ¥è¯¢ç»“æœé¡µé¢
                    goToStep(2);
                }
            });
            
            // æ›´æ”¹é¢„çº¦æŒ‰é’®äº‹ä»¶
            document.getElementById('change-appointment-btn').addEventListener('click', function() {
                // å…ˆå–æ¶ˆå½“å‰é¢„çº¦ - ä½¿ç”¨AppointmentManager
                DataSync.AppointmentManager.cancelAppointment(currentUser.name, currentUser.phone);
                
                // å‰å¾€é€‰æ‹©æ—¶é—´é¡µé¢
                document.getElementById('book-btn').click();
            });
            
            // ç¡®è®¤é¢„çº¦æŒ‰é’®äº‹ä»¶
            document.getElementById('confirm-time-btn').addEventListener('click', function() {
                if (!selectedSlot) {
                    alert('è¯·é€‰æ‹©ä¸€ä¸ªé¢„çº¦æ—¶æ®µ');
                    return;
                }
                
                const selectedDate = document.getElementById('booking-date').value;
                const dateText = document.getElementById('booking-date').options[document.getElementById('booking-date').selectedIndex].text;
                
                // åˆ›å»ºé¢„çº¦å¯¹è±¡
                const newAppointment = {
                    name: currentUser.name,
                    phone: currentUser.phone,
                    date: selectedDate,
                    time: selectedSlot,
                    displayDate: dateText
                };
                
                // ä½¿ç”¨AppointmentManageræ·»åŠ é¢„çº¦
                DataSync.AppointmentManager.addAppointment(newAppointment);
                
                // å¡«å……é¢„çº¦ä¿¡æ¯
                document.getElementById('booking-name').textContent = currentUser.name;
                document.getElementById('booking-phone').textContent = currentUser.phone;
                document.getElementById('booking-date-display').textContent = dateText;
                document.getElementById('booking-time-display').textContent = selectedSlot;
                
                // éšè—å–æ¶ˆå’Œæ›´æ”¹æŒ‰é’®ï¼Œæ˜¾ç¤ºæ–°é¢„çº¦æŒ‰é’®
                document.getElementById('cancel-appointment-btn').classList.add('hidden');
                document.getElementById('change-appointment-btn').classList.add('hidden');
                document.getElementById('new-appointment-btn').classList.remove('hidden');
                
                goToStep(4);
            });
            
            // è¿”å›æŸ¥è¯¢æŒ‰é’®äº‹ä»¶
            document.getElementById('back-to-query').addEventListener('click', function() {
                goToStep(1);
            });
            
            // è¿”å›ç»“æœæŒ‰é’®äº‹ä»¶
            document.getElementById('back-to-result').addEventListener('click', function() {
                goToStep(2);
            });
            
            // æ–°çš„æŸ¥è¯¢æŒ‰é’®äº‹ä»¶
            document.getElementById('new-query-btn').addEventListener('click', function() {
                // é‡ç½®è¡¨å•
                document.getElementById('name').value = '';
                document.getElementById('phone').value = '';
                currentUser = null;
                selectedSlot = null;
                // é‡ç½®æŒ‰é’®çŠ¶æ€
                document.getElementById('book-btn').classList.remove('hidden');
                document.getElementById('view-appointment-btn').classList.add('hidden');
                goToStep(1);
            });
            
            // é‡æ–°é¢„çº¦æŒ‰é’®äº‹ä»¶
            document.getElementById('new-appointment-btn').addEventListener('click', function() {
                // å…ˆå–æ¶ˆå½“å‰é¢„çº¦ - ä½¿ç”¨AppointmentManager
                DataSync.AppointmentManager.cancelAppointment(currentUser.name, currentUser.phone);
                
                // å‰å¾€é€‰æ‹©æ—¶é—´é¡µé¢
                document.getElementById('book-btn').click();
            });
            // æ·»åŠ æ•°æ®å˜æ›´äº‹ä»¶ç›‘å¬ï¼Œå®ç°å®æ—¶æ›´æ–°
            if (typeof DataSync !== 'undefined') {
                // ç›‘å¬æ¡ˆä»¶æ•°æ®å˜æ›´
                DataSync.on('casesUpdated', function() {
                    // å¦‚æœå½“å‰åœ¨æ­¥éª¤2ï¼ˆå®¡æ ¸ç»“æœé¡µé¢ï¼‰ï¼Œåˆ·æ–°æ•°æ®
                    if (!document.getElementById('form-step-2').classList.contains('hidden') && currentUser) {
                        const updatedUser = DataSync.CaseManager.getCaseByNameAndPhone(currentUser.name, currentUser.phone);
                        if (updatedUser) {
                            currentUser = updatedUser;
                            
                            const resultMessage = document.getElementById('result-message');
                            const resultActions = document.getElementById('result-actions');
                            
                            // æ¸…ç©ºä¹‹å‰çš„çŠ¶æ€
                            resultMessage.className = 'result-message';
                            resultActions.classList.add('hidden');
                            
                            // æŸ¥æ‰¾ç”¨æˆ·çš„é¢„çº¦è®°å½•
                            const userAppointment = DataSync.AppointmentManager.getAppointmentByUser(currentUser.name, currentUser.phone);
                            
                            // è®¾ç½®ç»“æœæ¶ˆæ¯å’Œæ ·å¼
                            if (currentUser.status === 'approved') {
                                if (userAppointment) {
                                    resultMessage.textContent = `æ­å–œï¼Œæ‚¨çš„ç”³è¯·å·²å®¡æ ¸é€šè¿‡ï¼æ‚¨å·²é¢„çº¦${userAppointment.displayDate} ${userAppointment.time}çš„åŠç†æ—¶æ®µ`;
                                    resultMessage.classList.add('result-success');
                                    // éšè—é¢„çº¦æŒ‰é’®ï¼Œæ˜¾ç¤ºæŸ¥çœ‹é¢„çº¦æŒ‰é’®
                                    document.getElementById('book-btn').classList.add('hidden');
                                    document.getElementById('view-appointment-btn').classList.remove('hidden');
                                } else {
                                    resultMessage.textContent = 'æ­å–œï¼Œæ‚¨çš„ç”³è¯·å·²å®¡æ ¸é€šè¿‡ï¼';
                                    resultMessage.classList.add('result-success');
                                    resultActions.classList.remove('hidden');
                                }
                            } else if (currentUser.status === 'rejected') {
                                resultMessage.textContent = currentUser.reason;
                                resultMessage.classList.add('result-rejected');
                            } else if (currentUser.status === 'pending') {
                                resultMessage.textContent = currentUser.reason;
                                resultMessage.classList.add('result-pending');
                            }
                        }
                    }
                });
                
                // ç›‘å¬é¢„çº¦æ•°æ®å˜æ›´
                DataSync.on('appointmentsUpdated', function() {
                    // å¦‚æœå½“å‰åœ¨æ­¥éª¤2ï¼ˆå®¡æ ¸ç»“æœé¡µé¢ï¼‰ï¼Œåˆ·æ–°é¢„çº¦çŠ¶æ€
                    if (!document.getElementById('form-step-2').classList.contains('hidden') && currentUser) {
                        const userAppointment = DataSync.AppointmentManager.getAppointmentByUser(currentUser.name, currentUser.phone);
                        const resultMessage = document.getElementById('result-message');
                        
                        if (currentUser.status === 'approved') {
                            if (userAppointment) {
                                resultMessage.textContent = `æ­å–œï¼Œæ‚¨çš„ç”³è¯·å·²å®¡æ ¸é€šè¿‡ï¼æ‚¨å·²é¢„çº¦${userAppointment.displayDate} ${userAppointment.time}çš„åŠç†æ—¶æ®µ`;
                                // éšè—é¢„çº¦æŒ‰é’®ï¼Œæ˜¾ç¤ºæŸ¥çœ‹é¢„çº¦æŒ‰é’®
                                document.getElementById('book-btn').classList.add('hidden');
                                document.getElementById('view-appointment-btn').classList.remove('hidden');
                            } else {
                                resultMessage.textContent = 'æ­å–œï¼Œæ‚¨çš„ç”³è¯·å·²å®¡æ ¸é€šè¿‡ï¼';
                                document.getElementById('book-btn').classList.remove('hidden');
                                document.getElementById('view-appointment-btn').classList.add('hidden');
                            }
                        }
                    }
                    
                    // å¦‚æœå½“å‰åœ¨æ­¥éª¤3ï¼ˆé€‰æ‹©æ—¶é—´é¡µé¢ï¼‰ï¼Œåˆ·æ–°å¯ç”¨æ—¶æ®µ
                    if (!document.getElementById('form-step-3').classList.contains('hidden')) {
                        const selectedDate = document.getElementById('booking-date').value;
                        if (selectedDate) {
                            generateTimeSlots(selectedDate);
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>