<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê°à‰ª∂ÁÆ°ÁêÜÁ≥ªÁªü - Áã¨Á´ãÁâà</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background-color: #1a73e8;
            color: white;
            padding: 15px 0;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 500;
        }
        
        .header .date {
            font-size: 14px;
            margin-top: 5px;
            opacity: 0.9;
        }
        
        .steps {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
            position: relative;
        }
        
        .steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 15%;
            right: 15%;
            height: 2px;
            background-color: #e0e0e0;
            z-index: 1;
        }
        
        .step {
            text-align: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }
        
        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e0e0e0;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .step.active .step-icon {
            background-color: #1a73e8;
            color: white;
        }
        
        .step-label {
            font-size: 14px;
            color: #666;
        }
        
        .step.active .step-label {
            color: #1a73e8;
            font-weight: 500;
        }
        
        .form-container {
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            max-width: 600px;
            margin: 0 auto;
        }
        
        h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        input[type="text"], input[type="tel"], select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        input[type="text"]:focus, input[type="tel"]:focus, select:focus {
            outline: none;
            border-color: #1a73e8;
        }
        
        .btn {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
        }
        
        .btn:hover {
            background-color: #1557b0;
        }
        
        .result-message {
            text-align: center;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .result-success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        
        .result-rejected {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        
        .result-pending {
            background-color: #fff8e1;
            color: #f57c00;
            border: 1px solid #ffe0b2;
        }
        
        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .time-slot {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .time-slot:hover {
            border-color: #1a73e8;
            background-color: #f5f7fa;
        }
        
        .time-slot.selected {
            background-color: #1a73e8;
            color: white;
            border-color: #1a73e8;
        }
        
        .time-slot.booked {
            background-color: #f5f5f5;
            color: #999;
            cursor: not-allowed;
            border-color: #ddd;
        }
        
        .help-tips {
            background-color: #f8f9fa;
            border-left: 4px solid #1a73e8;
            padding: 15px;
            margin-top: 30px;
            border-radius: 0 4px 4px 0;
        }
        
        .help-tips h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #1a73e8;
        }
        
        .help-tips ul {
            list-style-type: none;
            padding-left: 0;
        }
        
        .help-tips li {
            font-size: 14px;
            margin-bottom: 8px;
            padding-left: 15px;
            position: relative;
        }
        
        .help-tips li::before {
            content: '‚Ä¢';
            color: #1a73e8;
            position: absolute;
            left: 0;
        }
        
        .footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px 0;
            color: #666;
            font-size: 14px;
            border-top: 1px solid #e0e0e0;
        }
        
        .hidden {
            display: none;
        }
        
        .success-icon {
            font-size: 48px;
            color: #4caf50;
            margin-bottom: 20px;
        }
        
        .booking-details {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        
        .booking-details p {
            margin: 8px 0;
        }
        
        @media (max-width: 768px) {
            .steps {
                flex-wrap: wrap;
            }
            
            .steps::before {
                display: none;
            }
            
            .form-container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
            <div class="container">
                <h1>ÈùûÂÖ¨ËØÅÁªßÊâøÈ¢ÑÁ∫¶Á≥ªÁªü</h1>
                <div class="date" id="current-date"></div>
            </div>
        </div>
    
    <div class="container">
        <div class="steps">
            <div class="step active" id="step-1">
                <div class="step-icon">üîç</div>
                <div class="step-label">Êü•ËØ¢ËøõÂ∫¶</div>
            </div>
            <div class="step" id="step-2">
                <div class="step-icon">üìã</div>
                <div class="step-label">ÂÆ°Ê†∏ÁªìÊûú</div>
            </div>
            <div class="step" id="step-3">
                <div class="step-icon">üìÖ</div>
                <div class="step-label">ÈÄâÊã©Êó∂Èó¥</div>
            </div>
            <div class="step" id="step-4">
                <div class="step-icon">‚úÖ</div>
                <div class="step-label">ÂÆåÊàêÈ¢ÑÁ∫¶</div>
            </div>
        </div>
        
        <div class="form-container">
            <!-- Ê≠•È™§1: Êü•ËØ¢Ë°®Âçï -->
            <div id="form-step-1">
                <h2>Êü•ËØ¢Ê°à‰ª∂ËøõÂ∫¶</h2>
                <div class="form-group">
                    <label for="name">ËØ∑ËæìÂÖ•‰∫ßÊùÉ‰∫∫ÁöÑÂßìÂêç</label>
                    <input type="text" id="name" placeholder="ËØ∑ËæìÂÖ•‰∫ßÊùÉ‰∫∫ÁöÑÂßìÂêç">
                </div>
                <div class="form-group">
                    <label for="phone">ËØ∑ËæìÂÖ•ÊâãÊú∫Âè∑Á†Å</label>
                    <input type="tel" id="phone" placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÊâãÊú∫Âè∑Á†Å">
                </div>
                <button class="btn" id="query-btn">Êü•ËØ¢</button>
            </div>
            
            <!-- Ê≠•È™§2: ÂÆ°Ê†∏ÁªìÊûú -->
            <div id="form-step-2" class="hidden">
                <h2>ÂÆ°Ê†∏ÁªìÊûú</h2>
                <div id="result-message" class="result-message"></div>
                <div id="result-actions" class="hidden">
                    <button class="btn" id="book-btn">È¢ÑÁ∫¶Áé∞Âú∫ÂäûÁêÜ</button>
                </div>
                <button class="btn hidden" id="view-appointment-btn" style="margin-top: 10px;">Êü•ÁúãÂ∑≤È¢ÑÁ∫¶‰ø°ÊÅØ</button>
                <button class="btn" id="back-to-query" style="margin-top: 10px;">ËøîÂõûÊü•ËØ¢</button>
            </div>
            
            <!-- Ê≠•È™§3: ÈÄâÊã©Êó∂Èó¥ -->
            <div id="form-step-3" class="hidden">
                <h2>ÈÄâÊã©È¢ÑÁ∫¶Êó∂Èó¥</h2>
                <div class="form-group">
                    <label for="booking-year">ÈÄâÊã©Âπ¥‰ªΩ</label>
                    <select id="booking-year">
                        <option value="2025">2025Âπ¥</option>
                        <option value="2026">2026Âπ¥</option>
                        <option value="2027">2027Âπ¥</option>
                        <option value="2028">2028Âπ¥</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="booking-month">ÈÄâÊã©Êúà‰ªΩ</label>
                    <select id="booking-month">
                        <option value="1">1Êúà</option>
                        <option value="2">2Êúà</option>
                        <option value="3">3Êúà</option>
                        <option value="4">4Êúà</option>
                        <option value="5">5Êúà</option>
                        <option value="6">6Êúà</option>
                        <option value="7">7Êúà</option>
                        <option value="8">8Êúà</option>
                        <option value="9">9Êúà</option>
                        <option value="10">10Êúà</option>
                        <option value="11">11Êúà</option>
                        <option value="12">12Êúà</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="booking-date">ÈÄâÊã©Êó•Êúü</label>
                    <select id="booking-date"></select>
                </div>
                <div class="form-group">
                    <label>ÈÄâÊã©Êó∂Èó¥ÊÆµ</label>
                    <div class="time-slots" id="time-slots"></div>
                </div>
                <button class="btn" id="confirm-time-btn">Á°ÆËÆ§È¢ÑÁ∫¶</button>
                <button class="btn" id="back-to-result" style="margin-top: 10px; background-color: #666;">ËøîÂõûÁªìÊûú</button>
            </div>
            
            <!-- Ê≠•È™§4: ÂÆåÊàêÈ¢ÑÁ∫¶ -->
            <div id="form-step-4" class="hidden">
                <h2 style="text-align: center;">È¢ÑÁ∫¶ÊàêÂäüÔºÅ</h2>
                <div class="success-icon" style="text-align: center;">‚úì</div>
                <div class="booking-details">
                    <p><strong>ÂßìÂêçÔºö</strong><span id="booking-name"></span></p>
                    <p><strong>ÊâãÊú∫Âè∑Á†ÅÔºö</strong><span id="booking-phone"></span></p>
                    <p><strong>È¢ÑÁ∫¶Êó•ÊúüÔºö</strong><span id="booking-date-display"></span></p>
                    <p><strong>È¢ÑÁ∫¶Êó∂Èó¥Ôºö</strong><span id="booking-time-display"></span></p>
                </div>
                <p style="text-align: center; color: #666;">Êàë‰ª¨Â∑≤ÂêëÊÇ®ÁöÑÊâãÊú∫ÂèëÈÄÅ‰∫ÜÈ¢ÑÁ∫¶ÊàêÂäüÁü≠‰ø°ÔºåËØ∑ÂáÜÊó∂ÂâçÂæÄÂäûÁêÜ„ÄÇ</p>
                <button class="btn hidden" id="cancel-appointment-btn" style="margin-bottom: 10px;">ÂèñÊ∂àÈ¢ÑÁ∫¶</button>
                <button class="btn hidden" id="change-appointment-btn" style="margin-bottom: 10px;">Êõ¥ÊîπÈ¢ÑÁ∫¶Êó∂Èó¥</button>
                <button class="btn hidden" id="new-appointment-btn" style="margin-bottom: 10px;">ÈáçÊñ∞È¢ÑÁ∫¶</button>
                <button class="btn" id="new-query-btn">Êñ∞ÁöÑÊü•ËØ¢</button>
            </div>
        </div>
        
        <div class="help-tips">
            <h3>Ê∏©È¶®ÊèêÁ§∫</h3>
            <ul>
                <li>ÂÆ°Ê†∏ÈÄöËøáÂêéÔºåÂèØ‰ª•ÈöèÊó∂ËøõË°åÈ¢ÑÁ∫¶Êìç‰Ωú</li>
                <li>ÂäûÁêÜÂΩïÈü≥ÂΩïÂÉèÁöÑÊó∂Èó¥ÊöÇÊó∂‰ªÖ‰∏∫ÊØèÂë®ÁöÑÊòüÊúüÂõõ„ÄÅÊòüÊúü‰∫î</li>
                <li>È¢ÑÁ∫¶ÊàêÂäüÂêéÔºåÁ≥ªÁªüÂ∞ÜÂèëÈÄÅÁü≠‰ø°ÊèêÈÜíËá≥ÊÇ®È¢ÑÁïôÁöÑËÅîÁ≥ªÁîµËØù</li>
                <li>Â¶ÇÊúâÁñëÈóÆÔºåËØ∑Âú®Âë®‰∏ÄËá≥Âë®‰∫îÁöÑ‰∏äÁè≠Êó∂Èó¥ËÅîÁ≥ªÂ∑•‰Ωú‰∫∫ÂëòÔºö0668-2798581Ôºà‰∏äÂçà8:30-12:00Ôºå‰∏ãÂçà14:30-17:30Ôºâ</li>
            </ul>
        </div>
    </div>
    
    <div class="footer">
            <div class="container">
                ¬© 2023 ÈùûÂÖ¨ËØÅÁªßÊâøÈ¢ÑÁ∫¶Á≥ªÁªü - ‰øùÁïôÊâÄÊúâÊùÉÂà©
            </div>
        </div>
    
    <script src="data-sync.js"></script>
    <script>
        // ÂΩìÂâçÊó•ÊúüÊòæÁ§∫
        document.addEventListener('DOMContentLoaded', function() {
            // ËÆæÁΩÆÂΩìÂâçÊó•Êúü
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('zh-CN', options);
            
            // ‰ΩøÁî®DataSyncÊ®°Âùó
            // ÂΩìÂâçÁî®Êà∑‰ø°ÊÅØ
            let currentUser = null;
            let selectedSlot = null;
            
            // ÂàùÂßãÂåñDataSyncÊ®°Âùó
            if (typeof DataSync !== 'undefined') {
                DataSync.init();
            } else {
                console.error('DataSyncÊ®°ÂùóÊú™Âä†ËΩΩÊàêÂäü');
            }
            
            // Ê≠•È™§ÂØºËà™
            function goToStep(stepNumber) {
                // ÈöêËóèÊâÄÊúâÊ≠•È™§
                for (let i = 1; i <= 4; i++) {
                    document.getElementById(`form-step-${i}`).classList.add('hidden');
                    document.getElementById(`step-${i}`).classList.remove('active');
                }
                
                // ÊòæÁ§∫ÂΩìÂâçÊ≠•È™§
                document.getElementById(`form-step-${stepNumber}`).classList.remove('hidden');
                document.getElementById(`step-${stepNumber}`).classList.add('active');
                
                // Êõ¥Êñ∞ËøõÂ∫¶Êù°
                for (let i = 1; i <= stepNumber; i++) {
                    document.getElementById(`step-${i}`).classList.add('active');
                }
            }
            
            // ÁîüÊàêÂèØÁî®Êó∂ÊÆµ
            function generateTimeSlots(date) {
                const slotsContainer = document.getElementById('time-slots');
                slotsContainer.innerHTML = '';
                
                const slots = ['09:00-10:00', '10:00-11:00', '15:00-16:00', '16:00-17:00'];
                // Ëé∑ÂèñÂ∑≤È¢ÑÁ∫¶Êó∂ÊÆµ - ‰ΩøÁî®AppointmentManager
                const booked = DataSync.AppointmentManager.getBookedSlotsByDate(date);
                
                slots.forEach(slot => {
                    const slotElement = document.createElement('div');
                    slotElement.className = 'time-slot';
                    slotElement.textContent = slot;
                    
                    if (booked.includes(slot)) {
                        slotElement.classList.add('booked');
                    } else {
                        slotElement.addEventListener('click', function() {
                            // ÁßªÈô§ÂÖ∂‰ªñÈÄâ‰∏≠Áä∂ÊÄÅ
                            document.querySelectorAll('.time-slot.selected').forEach(el => {
                                el.classList.remove('selected');
                            });
                            // Ê∑ªÂä†ÂΩìÂâçÈÄâ‰∏≠Áä∂ÊÄÅ
                            slotElement.classList.add('selected');
                            selectedSlot = slot;
                        });
                    }
                    
                    slotsContainer.appendChild(slotElement);
                });
            }
            
            // Êü•ËØ¢ÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('query-btn').addEventListener('click', function() {
                const name = document.getElementById('name').value.trim();
                const phone = document.getElementById('phone').value.trim();
                
                if (!name || !phone) {
                    alert('ËØ∑ËæìÂÖ•ÂßìÂêçÂíåÊâãÊú∫Âè∑Á†Å');
                    return;
                }
                
                // Êü•ËØ¢Êï∞ÊçÆÂ∫ì - ‰ΩøÁî®CaseManager
                const user = DataSync.CaseManager.getCaseByNameAndPhone(name, phone);
                
                if (user) {
                    currentUser = user;
                    // ËÆæÁΩÆÁªìÊûúÊï∞ÊçÆ
                    const resultMessage = document.getElementById('result-message');
                    const resultActions = document.getElementById('result-actions');
                    
                    // Ê∏ÖÁ©∫‰πãÂâçÁöÑÁä∂ÊÄÅ
                    resultMessage.className = 'result-message';
                    resultActions.classList.add('hidden');
                    
                    // Êü•ÊâæÁî®Êà∑ÁöÑÈ¢ÑÁ∫¶ËÆ∞ÂΩï - ‰ΩøÁî®AppointmentManager
                    const userAppointment = DataSync.AppointmentManager.getAppointmentByUser(name, phone);
                    
                    // ËÆæÁΩÆÁªìÊûúÊ∂àÊÅØÂíåÊ†∑Âºè
                    if (user.status === 'approved') {
                        if (userAppointment) {
                            resultMessage.innerHTML = `<strong>ÊÅ≠ÂñúÔºåÊÇ®ÁöÑÁî≥ËØ∑Â∑≤ÂÆ°Ê†∏ÈÄöËøáÔºÅ</strong><br/>ÊÇ®Â∑≤È¢ÑÁ∫¶${userAppointment.displayDate} ${userAppointment.time}ÁöÑÂäûÁêÜÊó∂ÊÆµ`;
                            resultMessage.classList.add('result-success');
                            // ÈöêËóèÈ¢ÑÁ∫¶ÊåâÈíÆÔºåÊòæÁ§∫Êü•ÁúãÈ¢ÑÁ∫¶ÊåâÈíÆ
                            document.getElementById('book-btn').classList.add('hidden');
                            document.getElementById('view-appointment-btn').classList.remove('hidden');
                        } else {
                            resultMessage.innerHTML = '<strong>ÊÅ≠ÂñúÔºåÊÇ®ÁöÑÁî≥ËØ∑Â∑≤ÂÆ°Ê†∏ÈÄöËøáÔºÅ</strong><br/>ÊÇ®ÂèØ‰ª•Á´ãÂç≥ËøõË°åÁé∞Âú∫ÂäûÁêÜÈ¢ÑÁ∫¶';
                            resultMessage.classList.add('result-success');
                            resultActions.classList.remove('hidden');
                        }
                    } else if (user.status === 'rejected') {
                        resultMessage.innerHTML = `<strong>ÂæàÊä±Ê≠âÔºåÊÇ®ÁöÑÁî≥ËØ∑Êú™ÈÄöËøáÂÆ°Ê†∏</strong><br/>${user.reason}`;
                        resultMessage.classList.add('result-rejected');
                    } else if (user.status === 'pending') {
                        resultMessage.innerHTML = `<strong>ÊÇ®ÁöÑÁî≥ËØ∑Ê≠£Âú®Â§ÑÁêÜ‰∏≠</strong><br/>${user.reason || 'ËØ∑ËÄêÂøÉÁ≠âÂæÖÂÆ°Ê†∏ÁªìÊûú'}`;
                        resultMessage.classList.add('result-pending');
                    }
                    
                    // Á°Æ‰øùÁªìÊûúÂå∫ÂüüÊúâË∂≥Â§üÁöÑÈ´òÂ∫¶ÊòæÁ§∫ÂÆåÊï¥ÂÜÖÂÆπ
                    resultMessage.style.minHeight = '80px';
                    resultMessage.style.display = 'flex';
                    resultMessage.style.flexDirection = 'column';
                    resultMessage.style.justifyContent = 'center';
                    
                    // ÂØºËà™Âà∞Ê≠•È™§2
                    goToStep(2);
                } else {
                    alert('Êú™ÊâæÂà∞Áõ∏ÂÖ≥ËÆ∞ÂΩïÔºåËØ∑Ê£ÄÊü•ÂßìÂêçÂíåÊâãÊú∫Âè∑Á†ÅÊòØÂê¶Ê≠£Á°Æ');
                }
            });
            
            // Ê†πÊçÆÂπ¥ÊúàËé∑ÂèñÊâÄÊúâÂë®ÂõõÂíåÂë®‰∫îÁöÑÊó•Êúü
            function getWeekdaysInMonth(year, month) {
                const weekdays = [];
                const daysInMonth = new Date(year, month, 0).getDate();
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month - 1, day);
                    const dayOfWeek = date.getDay();
                    
                    // Âë®Âõõ(4)ÊàñÂë®‰∫î(5)
                    if (dayOfWeek === 4 || dayOfWeek === 5) {
                        const formattedDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const dayName = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'][dayOfWeek];
                        weekdays.push({
                            date: formattedDate,
                            display: `${month}Êúà${day}Êó• (Âë®${dayName})`
                        });
                    }
                }
                
                return weekdays;
            }
            
            // Â°´ÂÖÖÊó•Êúü‰∏ãÊãâÊ°Ü
            function populateDateDropdown(year, month) {
                const dateSelect = document.getElementById('booking-date');
                dateSelect.innerHTML = '';
                
                const weekdays = getWeekdaysInMonth(year, month);
                
                if (weekdays.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'ËØ•Êúà‰ªΩÊ≤°ÊúâÂèØÁî®ÁöÑÂë®ÂõõÊàñÂë®‰∫î';
                    option.disabled = true;
                    dateSelect.appendChild(option);
                } else {
                    weekdays.forEach(day => {
                        const option = document.createElement('option');
                        option.value = day.date;
                        option.textContent = day.display;
                        dateSelect.appendChild(option);
                    });
                    
                    // ÈªòËÆ§ÈÄâÊã©Á¨¨‰∏Ä‰∏™Êó•Êúü
                    if (dateSelect.options.length > 0) {
                        dateSelect.selectedIndex = 0;
                        generateTimeSlots(dateSelect.value);
                    }
                }
            }
            
            // È¢ÑÁ∫¶ÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('book-btn').addEventListener('click', function() {
                // ÈáçÁΩÆÊåâÈíÆÁä∂ÊÄÅ
                document.getElementById('book-btn').classList.remove('hidden');
                document.getElementById('view-appointment-btn').classList.add('hidden');
                // ÂàùÂßãÂåñÊó•ÊúüÈÄâÊã©Âô®
                const year = parseInt(document.getElementById('booking-year').value);
                const month = parseInt(document.getElementById('booking-month').value);
                populateDateDropdown(year, month);
                goToStep(3);
            });
            
            // Âπ¥‰ªΩÈÄâÊã©ÂèòÊõ¥‰∫ã‰ª∂
            document.getElementById('booking-year').addEventListener('change', function() {
                const year = parseInt(this.value);
                const month = parseInt(document.getElementById('booking-month').value);
                populateDateDropdown(year, month);
                selectedSlot = null;
            });
            
            // Êúà‰ªΩÈÄâÊã©ÂèòÊõ¥‰∫ã‰ª∂
            document.getElementById('booking-month').addEventListener('change', function() {
                const year = parseInt(document.getElementById('booking-year').value);
                const month = parseInt(this.value);
                populateDateDropdown(year, month);
                selectedSlot = null;
            });
            
            // Êó•ÊúüÈÄâÊã©ÂèòÊõ¥‰∫ã‰ª∂
            document.getElementById('booking-date').addEventListener('change', function() {
                if (this.value) {
                    generateTimeSlots(this.value);
                }
                selectedSlot = null;
            });
            
            // Êü•ÁúãÈ¢ÑÁ∫¶ÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('view-appointment-btn').addEventListener('click', function() {
                const userAppointment = DataSync.AppointmentManager.getAppointmentByUser(currentUser.name, currentUser.phone);
                if (userAppointment) {
                    // Â°´ÂÖÖÈ¢ÑÁ∫¶‰ø°ÊÅØ
                    document.getElementById('booking-name').textContent = userAppointment.name;
                    document.getElementById('booking-phone').textContent = userAppointment.phone;
                    document.getElementById('booking-date-display').textContent = userAppointment.displayDate;
                    document.getElementById('booking-time-display').textContent = userAppointment.time;
                    
                    // ÊòæÁ§∫ÂèñÊ∂àÂíåÊõ¥ÊîπÊåâÈíÆ
                    document.getElementById('cancel-appointment-btn').classList.remove('hidden');
                    document.getElementById('change-appointment-btn').classList.remove('hidden');
                    document.getElementById('new-appointment-btn').classList.add('hidden');
                    
                    goToStep(4);
                }
            });
            
            // ÂèñÊ∂àÈ¢ÑÁ∫¶ÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('cancel-appointment-btn').addEventListener('click', function() {
                if (confirm('Á°ÆÂÆöË¶ÅÂèñÊ∂àÈ¢ÑÁ∫¶ÂêóÔºü')) {
                    // ‰ΩøÁî®AppointmentManagerÂèñÊ∂àÈ¢ÑÁ∫¶
                    DataSync.AppointmentManager.cancelAppointment(currentUser.name, currentUser.phone);
                    
                    alert('È¢ÑÁ∫¶Â∑≤ÂèñÊ∂à');
                    // ËøîÂõûÊü•ËØ¢ÁªìÊûúÈ°µÈù¢
                    goToStep(2);
                }
            });
            
            // Êõ¥ÊîπÈ¢ÑÁ∫¶ÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('change-appointment-btn').addEventListener('click', function() {
                // ÂÖàÂèñÊ∂àÂΩìÂâçÈ¢ÑÁ∫¶ - ‰ΩøÁî®AppointmentManager
                DataSync.AppointmentManager.cancelAppointment(currentUser.name, currentUser.phone);
                
                // ÂâçÂæÄÈÄâÊã©Êó∂Èó¥È°µÈù¢
                document.getElementById('book-btn').click();
            });
            
            // Á°ÆËÆ§È¢ÑÁ∫¶ÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('confirm-time-btn').addEventListener('click', function() {
                if (!selectedSlot) {
                    alert('ËØ∑ÈÄâÊã©‰∏Ä‰∏™È¢ÑÁ∫¶Êó∂ÊÆµ');
                    return;
                }
                
                const selectedDate = document.getElementById('booking-date').value;
                const dateText = document.getElementById('booking-date').options[document.getElementById('booking-date').selectedIndex].text;
                
                // ÂàõÂª∫È¢ÑÁ∫¶ÂØπË±°
                const newAppointment = {
                    name: currentUser.name,
                    phone: currentUser.phone,
                    date: selectedDate,
                    time: selectedSlot,
                    displayDate: dateText
                };
                
                // ‰ΩøÁî®AppointmentManagerÊ∑ªÂä†È¢ÑÁ∫¶
                DataSync.AppointmentManager.addAppointment(newAppointment);
                
                // Â°´ÂÖÖÈ¢ÑÁ∫¶‰ø°ÊÅØ
                document.getElementById('booking-name').textContent = currentUser.name;
                document.getElementById('booking-phone').textContent = currentUser.phone;
                document.getElementById('booking-date-display').textContent = dateText;
                document.getElementById('booking-time-display').textContent = selectedSlot;
                
                // ÈöêËóèÂèñÊ∂àÂíåÊõ¥ÊîπÊåâÈíÆÔºåÊòæÁ§∫Êñ∞È¢ÑÁ∫¶ÊåâÈíÆ
                document.getElementById('cancel-appointment-btn').classList.add('hidden');
                document.getElementById('change-appointment-btn').classList.add('hidden');
                document.getElementById('new-appointment-btn').classList.remove('hidden');
                
                goToStep(4);
            });
            
            // ËøîÂõûÊü•ËØ¢ÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('back-to-query').addEventListener('click', function() {
                goToStep(1);
            });
            
            // ËøîÂõûÁªìÊûúÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('back-to-result').addEventListener('click', function() {
                goToStep(2);
            });
            
            // Êñ∞ÁöÑÊü•ËØ¢ÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('new-query-btn').addEventListener('click', function() {
                // ÈáçÁΩÆË°®Âçï
                document.getElementById('name').value = '';
                document.getElementById('phone').value = '';
                currentUser = null;
                selectedSlot = null;
                // ÈáçÁΩÆÊåâÈíÆÁä∂ÊÄÅ
                document.getElementById('book-btn').classList.remove('hidden');
                document.getElementById('view-appointment-btn').classList.add('hidden');
                goToStep(1);
            });
            
            // ÈáçÊñ∞È¢ÑÁ∫¶ÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('new-appointment-btn').addEventListener('click', function() {
                // ÂÖàÂèñÊ∂àÂΩìÂâçÈ¢ÑÁ∫¶ - ‰ΩøÁî®AppointmentManager
                DataSync.AppointmentManager.cancelAppointment(currentUser.name, currentUser.phone);
                
                // ÂâçÂæÄÈÄâÊã©Êó∂Èó¥È°µÈù¢
                document.getElementById('book-btn').click();
            });
            // Ê∑ªÂä†Êï∞ÊçÆÂèòÊõ¥‰∫ã‰ª∂ÁõëÂê¨ÔºåÂÆûÁé∞ÂÆûÊó∂Êõ¥Êñ∞
            if (typeof DataSync !== 'undefined') {
                // ÁõëÂê¨Ê°à‰ª∂Êï∞ÊçÆÂèòÊõ¥
                DataSync.on('casesUpdated', function() {
                    // Â¶ÇÊûúÂΩìÂâçÂú®Ê≠•È™§2ÔºàÂÆ°Ê†∏ÁªìÊûúÈ°µÈù¢ÔºâÔºåÂà∑Êñ∞Êï∞ÊçÆ
                    if (!document.getElementById('form-step-2').classList.contains('hidden') && currentUser) {
                        const updatedUser = DataSync.CaseManager.getCaseByNameAndPhone(currentUser.name, currentUser.phone);
                        if (updatedUser) {
                            currentUser = updatedUser;
                            
                            const resultMessage = document.getElementById('result-message');
                            const resultActions = document.getElementById('result-actions');
                            
                            // Ê∏ÖÁ©∫‰πãÂâçÁöÑÁä∂ÊÄÅ
                            resultMessage.className = 'result-message';
                            resultActions.classList.add('hidden');
                            
                            // Êü•ÊâæÁî®Êà∑ÁöÑÈ¢ÑÁ∫¶ËÆ∞ÂΩï
                            const userAppointment = DataSync.AppointmentManager.getAppointmentByUser(currentUser.name, currentUser.phone);
                            
                            // ËÆæÁΩÆÁªìÊûúÊ∂àÊÅØÂíåÊ†∑Âºè
                            if (currentUser.status === 'approved') {
                                if (userAppointment) {
                                    resultMessage.textContent = `ÊÅ≠ÂñúÔºåÊÇ®ÁöÑÁî≥ËØ∑Â∑≤ÂÆ°Ê†∏ÈÄöËøáÔºÅÊÇ®Â∑≤È¢ÑÁ∫¶${userAppointment.displayDate} ${userAppointment.time}ÁöÑÂäûÁêÜÊó∂ÊÆµ`;
                                    resultMessage.classList.add('result-success');
                                    // ÈöêËóèÈ¢ÑÁ∫¶ÊåâÈíÆÔºåÊòæÁ§∫Êü•ÁúãÈ¢ÑÁ∫¶ÊåâÈíÆ
                                    document.getElementById('book-btn').classList.add('hidden');
                                    document.getElementById('view-appointment-btn').classList.remove('hidden');
                                } else {
                                    resultMessage.textContent = 'ÊÅ≠ÂñúÔºåÊÇ®ÁöÑÁî≥ËØ∑Â∑≤ÂÆ°Ê†∏ÈÄöËøáÔºÅ';
                                    resultMessage.classList.add('result-success');
                                    resultActions.classList.remove('hidden');
                                }
                            } else if (currentUser.status === 'rejected') {
                                resultMessage.textContent = currentUser.reason;
                                resultMessage.classList.add('result-rejected');
                            } else if (currentUser.status === 'pending') {
                                resultMessage.textContent = currentUser.reason;
                                resultMessage.classList.add('result-pending');
                            }
                        }
                    }
                });
                
                // ÁõëÂê¨È¢ÑÁ∫¶Êï∞ÊçÆÂèòÊõ¥
                DataSync.on('appointmentsUpdated', function() {
                    // Â¶ÇÊûúÂΩìÂâçÂú®Ê≠•È™§2ÔºàÂÆ°Ê†∏ÁªìÊûúÈ°µÈù¢ÔºâÔºåÂà∑Êñ∞È¢ÑÁ∫¶Áä∂ÊÄÅ
                    if (!document.getElementById('form-step-2').classList.contains('hidden') && currentUser) {
                        const userAppointment = DataSync.AppointmentManager.getAppointmentByUser(currentUser.name, currentUser.phone);
                        const resultMessage = document.getElementById('result-message');
                        
                        if (currentUser.status === 'approved') {
                            if (userAppointment) {
                                resultMessage.textContent = `ÊÅ≠ÂñúÔºåÊÇ®ÁöÑÁî≥ËØ∑Â∑≤ÂÆ°Ê†∏ÈÄöËøáÔºÅÊÇ®Â∑≤È¢ÑÁ∫¶${userAppointment.displayDate} ${userAppointment.time}ÁöÑÂäûÁêÜÊó∂ÊÆµ`;
                                // ÈöêËóèÈ¢ÑÁ∫¶ÊåâÈíÆÔºåÊòæÁ§∫Êü•ÁúãÈ¢ÑÁ∫¶ÊåâÈíÆ
                                document.getElementById('book-btn').classList.add('hidden');
                                document.getElementById('view-appointment-btn').classList.remove('hidden');
                            } else {
                                resultMessage.textContent = 'ÊÅ≠ÂñúÔºåÊÇ®ÁöÑÁî≥ËØ∑Â∑≤ÂÆ°Ê†∏ÈÄöËøáÔºÅ';
                                document.getElementById('book-btn').classList.remove('hidden');
                                document.getElementById('view-appointment-btn').classList.add('hidden');
                            }
                        }
                    }
                    
                    // Â¶ÇÊûúÂΩìÂâçÂú®Ê≠•È™§3ÔºàÈÄâÊã©Êó∂Èó¥È°µÈù¢ÔºâÔºåÂà∑Êñ∞ÂèØÁî®Êó∂ÊÆµ
                    if (!document.getElementById('form-step-3').classList.contains('hidden')) {
                        const selectedDate = document.getElementById('booking-date').value;
                        if (selectedDate) {
                            generateTimeSlots(selectedDate);
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>